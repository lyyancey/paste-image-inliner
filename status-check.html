<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>插件状态检查</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-ok { border-left: 4px solid #4caf50; }
        .status-error { border-left: 4px solid #f44336; }
        .status-warning { border-left: 4px solid #ff9800; }
        .btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #1976d2; }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        h1 { color: #333; }
        h3 { color: #666; margin-top: 0; }
    </style>
</head>
<body>
    <h1>🔧 Chrome插件状态检查</h1>
    
    <div class="status-card" id="extensionStatus">
        <h3>插件连接状态</h3>
        <div id="extensionResult">检查中...</div>
        <button class="btn" onclick="checkExtension()">重新检查</button>
    </div>

    <div class="status-card" id="imageStatus">
        <h3>图片获取测试</h3>
        <div id="imageResult">等待测试...</div>
        <button class="btn" onclick="testImages()">测试图片获取</button>
    </div>

    <div class="status-card" id="clipboardStatus">
        <h3>剪贴板权限</h3>
        <div id="clipboardResult">等待测试...</div>
        <button class="btn" onclick="testClipboard()">测试剪贴板</button>
    </div>

    <div class="status-card">
        <h3>操作日志</h3>
        <div class="log" id="logArea"></div>
        <button class="btn" onclick="clearLog()">清空日志</button>
    </div>

    <div class="status-card">
        <h3>修复建议</h3>
        <div id="suggestions">
            <p>💡 如果出现"Extension context invalidated"错误：</p>
            <ul>
                <li>1. 刷新当前页面 (F5)</li>
                <li>2. 在扩展管理页面重新启用插件</li>
                <li>3. 检查是否有插件更新</li>
                <li>4. 重启浏览器</li>
            </ul>
            <button class="btn" onclick="window.location.reload()">刷新页面</button>
        </div>
    </div>

    <script>
        const logArea = document.getElementById('logArea');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : type === 'warning' ? '#ff9800' : '#333';
            div.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            logArea.innerHTML = '';
        }
        
        function setStatus(elementId, content, status) {
            const element = document.getElementById(elementId);
            element.className = `status-card status-${status}`;
            document.getElementById(elementId.replace('Status', 'Result')).innerHTML = content;
        }
        
        async function checkExtension() {
            log('检查插件连接状态...');
            
            try {
                if (typeof chrome === 'undefined') {
                    throw new Error('Chrome API不可用');
                }
                
                if (!chrome.runtime) {
                    throw new Error('chrome.runtime不可用');
                }
                
                if (!chrome.runtime.id) {
                    throw new Error('插件ID不可用');
                }
                
                // 测试基本通信
                const response = await chrome.runtime.sendMessage({ type: 'PING' });
                
                setStatus('extensionStatus', '✅ 插件连接正常', 'ok');
                log('插件连接检查通过', 'success');
                
            } catch (error) {
                setStatus('extensionStatus', `❌ 插件连接失败: ${error.message}`, 'error');
                log(`插件连接失败: ${error.message}`, 'error');
                
                if (error.message.includes('Extension context invalidated')) {
                    log('检测到扩展上下文失效，需要刷新页面', 'warning');
                }
            }
        }
        
        async function testImages() {
            log('开始图片获取测试...');
            
            try {
                const testUrls = [
                    'https://via.placeholder.com/100x100/ff0000/ffffff?text=TEST'
                ];
                
                const response = await chrome.runtime.sendMessage({
                    type: 'FETCH_IMAGE_TO_DATAURL',
                    urls: testUrls
                });
                
                if (response && response.results) {
                    const result = response.results[testUrls[0]];
                    if (result && result.ok) {
                        setStatus('imageStatus', '✅ 图片获取成功', 'ok');
                        log('图片获取测试通过', 'success');
                    } else {
                        setStatus('imageStatus', `❌ 图片获取失败: ${result.error}`, 'error');
                        log(`图片获取失败: ${result.error}`, 'error');
                    }
                } else {
                    setStatus('imageStatus', '❌ 无效响应', 'error');
                    log('收到无效响应', 'error');
                }
                
            } catch (error) {
                setStatus('imageStatus', `❌ 图片测试失败: ${error.message}`, 'error');
                log(`图片测试失败: ${error.message}`, 'error');
            }
        }
        
        async function testClipboard() {
            log('测试剪贴板权限...');
            
            try {
                // 测试读取
                await navigator.clipboard.read();
                log('剪贴板读取权限正常', 'success');
                
                // 测试写入
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'text/plain': new Blob(['测试文本'], { type: 'text/plain' })
                    })
                ]);
                log('剪贴板写入权限正常', 'success');
                
                setStatus('clipboardStatus', '✅ 剪贴板权限正常', 'ok');
                
            } catch (error) {
                setStatus('clipboardStatus', `❌ 剪贴板权限失败: ${error.message}`, 'error');
                log(`剪贴板权限测试失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', () => {
            log('页面加载完成，开始自动检查...');
            checkExtension();
        });
        
        // 监听扩展上下文失效
        window.addEventListener('error', (e) => {
            if (e.message.includes('Extension context invalidated')) {
                log('检测到扩展上下文失效错误', 'error');
                setStatus('extensionStatus', '❌ 扩展上下文失效，需要刷新页面', 'error');
            }
        });
    </script>
</body>
</html>
