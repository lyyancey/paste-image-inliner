<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è½¬æ¢è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .source-area {
            background: #0e2f44;
            border: 2px solid #1ba1e2;
        }
        .debug-panel {
            background: #2d2d30;
            border: 1px solid #608b4e;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .test-content {
            background: white;
            color: black;
            padding: 15px;
            border-radius: 4px;
        }
        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }
        .btn:hover { background: #1177bb; }
        .btn.danger { background: #c5282f; }
        .btn.danger:hover { background: #d73a42; }
        .btn.success { background: #16825d; }
        .btn.success:hover { background: #1a9d71; }
        
        .log-error { color: #f85149; }
        .log-warn { color: #f2cc60; }
        .log-info { color: #79c0ff; }
        .log-success { color: #3fb950; }
        
        h1, h2, h3 { color: #79c0ff; }
        
        .test-content img {
            max-width: 100px;
            margin: 5px;
            border: 2px solid #007acc;
        }
        
        .status-item {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å›¾ç‰‡å†…è”è½¬æ¢è°ƒè¯•å·¥å…·</h1>
    
    <div class="container">
        <h3>ğŸ“‹ æ§åˆ¶é¢æ¿</h3>
        <button class="btn" onclick="testImageFetch()">æµ‹è¯•å›¾ç‰‡è·å–</button>
        <button class="btn" onclick="testClipboardRead()">æµ‹è¯•å‰ªè´´æ¿è¯»å–</button>
        <button class="btn" onclick="testClipboardWrite()">æµ‹è¯•å‰ªè´´æ¿å†™å…¥</button>
        <button class="btn success" onclick="runFullTest()">å®Œæ•´æµ‹è¯•æµç¨‹</button>
        <button class="btn danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="container source-area">
        <h3>ğŸ“ æµ‹è¯•å†…å®¹åŒºåŸŸ</h3>
        <div class="test-content" id="testContent">
            <h4>æµ‹è¯•æ ‡é¢˜</h4>
            <p>è¿™æ˜¯åŒ…å«<strong style="color: red;">æ ¼å¼</strong>çš„æ–‡å­—</p>
            <p>å›¾ç‰‡1ï¼š<img src="https://via.placeholder.com/80x60/ff0000/ffffff?text=Test1" alt="æµ‹è¯•å›¾ç‰‡1"></p>
            <p>å›¾ç‰‡2ï¼š<img src="https://via.placeholder.com/80x60/00ff00/ffffff?text=Test2" alt="æµ‹è¯•å›¾ç‰‡2"></p>
            <p>å›¾ç‰‡3ï¼š<img src="https://httpbin.org/image/png" alt="PNGå›¾ç‰‡"></p>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“Š è°ƒè¯•æ—¥å¿—</h3>
        <div class="debug-panel" id="debugLog"></div>
    </div>

    <div class="container">
        <h3>ğŸ“‹ å‰ªè´´æ¿çŠ¶æ€</h3>
        <div id="clipboardStatus">
            <div class="status-item">ç­‰å¾…æ£€æµ‹...</div>
        </div>
    </div>

    <script>
        const debugLog = document.getElementById('debugLog');
        const clipboardStatus = document.getElementById('clipboardStatus');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            debugLog.textContent += logEntry;
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // ä¹Ÿè¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`%c${logEntry}`, `color: ${getLogColor(type)}`);
        }
        
        function getLogColor(type) {
            switch(type) {
                case 'error': return '#f85149';
                case 'warn': return '#f2cc60';
                case 'success': return '#3fb950';
                default: return '#79c0ff';
            }
        }
        
        function clearLog() {
            debugLog.textContent = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }
        
        async function testImageFetch() {
            log('ğŸ–¼ï¸ å¼€å§‹æµ‹è¯•å›¾ç‰‡è·å–...', 'info');
            
            const testUrls = [
                'https://via.placeholder.com/80x60/ff0000/ffffff?text=Test1',
                'https://via.placeholder.com/80x60/00ff00/ffffff?text=Test2',
                'https://httpbin.org/image/png'
            ];
            
            try {
                log('ğŸ“¡ å‘background scriptå‘é€è¯·æ±‚...', 'info');
                const response = await chrome.runtime.sendMessage({
                    type: 'FETCH_IMAGE_TO_DATAURL',
                    urls: testUrls
                });
                
                log('ğŸ“¡ æ”¶åˆ°å“åº”:', 'info');
                log(JSON.stringify(response, null, 2), 'info');
                
                if (response && response.results) {
                    let successCount = 0;
                    for (const [url, result] of Object.entries(response.results)) {
                        if (result.ok) {
                            successCount++;
                            log(`âœ… æˆåŠŸ: ${url} -> data URL (${result.originalSize} bytes)`, 'success');
                        } else {
                            log(`âŒ å¤±è´¥: ${url} -> ${result.error}`, 'error');
                        }
                    }
                    log(`ğŸ“Š æ€»ç»“: ${successCount}/${testUrls.length} å¼ å›¾ç‰‡è½¬æ¢æˆåŠŸ`, successCount === testUrls.length ? 'success' : 'warn');
                } else {
                    log('âŒ æœªæ”¶åˆ°æœ‰æ•ˆå“åº”', 'error');
                }
                
            } catch (error) {
                log(`âŒ å›¾ç‰‡è·å–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testClipboardRead() {
            log('ğŸ“‹ å¼€å§‹æµ‹è¯•å‰ªè´´æ¿è¯»å–...', 'info');
            
            try {
                const items = await navigator.clipboard.read();
                log(`ğŸ“‹ å‰ªè´´æ¿ä¸­æœ‰ ${items.length} ä¸ªé¡¹ç›®`, 'info');
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    log(`é¡¹ç›® ${i + 1} ç±»å‹: ${item.types.join(', ')}`, 'info');
                    
                    if (item.types.includes('text/html')) {
                        const htmlBlob = await item.getType('text/html');
                        const html = await htmlBlob.text();
                        log(`HTMLå†…å®¹é•¿åº¦: ${html.length} å­—ç¬¦`, 'info');
                        log(`HTMLé¢„è§ˆ: ${html.substring(0, 200)}...`, 'info');
                        
                        const imgCount = (html.match(/<img/g) || []).length;
                        const dataUrlCount = (html.match(/src="data:image/g) || []).length;
                        log(`åŒ…å«å›¾ç‰‡: ${imgCount} ä¸ª, data URL: ${dataUrlCount} ä¸ª`, 'info');
                    }
                    
                    if (item.types.includes('text/plain')) {
                        const textBlob = await item.getType('text/plain');
                        const text = await textBlob.text();
                        log(`çº¯æ–‡æœ¬é•¿åº¦: ${text.length} å­—ç¬¦`, 'info');
                    }
                }
                
                log('âœ… å‰ªè´´æ¿è¯»å–æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ å‰ªè´´æ¿è¯»å–å¤±è´¥: ${error.message}`, 'error');
                log('ğŸ’¡ æç¤º: å¯èƒ½éœ€è¦å…ˆå¤åˆ¶ä¸€äº›å†…å®¹', 'warn');
            }
        }
        
        async function testClipboardWrite() {
            log('âœï¸ å¼€å§‹æµ‹è¯•å‰ªè´´æ¿å†™å…¥...', 'info');
            
            const testHtml = `<p>æµ‹è¯•HTMLå†…å®¹</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" alt="æµ‹è¯•">`;
            const testText = 'æµ‹è¯•æ–‡æœ¬å†…å®¹';
            
            try {
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': new Blob([testHtml], { type: 'text/html' }),
                        'text/plain': new Blob([testText], { type: 'text/plain' })
                    })
                ]);
                
                log('âœ… å‰ªè´´æ¿å†™å…¥æˆåŠŸ', 'success');
                log('ğŸ’¡ è¯·åœ¨å…¶ä»–åœ°æ–¹ç²˜è´´ä»¥éªŒè¯å†…å®¹', 'info');
                
            } catch (error) {
                log(`âŒ å‰ªè´´æ¿å†™å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function runFullTest() {
            log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...', 'info');
            log('=' * 50, 'info');
            
            // 1. é€‰æ‹©æµ‹è¯•å†…å®¹
            const testContent = document.getElementById('testContent');
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(testContent);
            selection.removeAllRanges();
            selection.addRange(range);
            
            log('1ï¸âƒ£ å·²é€‰æ‹©æµ‹è¯•å†…å®¹', 'info');
            
            // 2. æ¨¡æ‹Ÿå¤åˆ¶æ“ä½œ
            try {
                const fragment = range.cloneContents();
                const images = fragment.querySelectorAll('img');
                log(`2ï¸âƒ£ å‘ç° ${images.length} å¼ å›¾ç‰‡`, 'info');
                
                const imageUrls = Array.from(images)
                    .map(img => img.src)
                    .filter(src => src && !src.startsWith('data:'));
                
                log(`3ï¸âƒ£ éœ€è¦è½¬æ¢çš„å›¾ç‰‡URL: ${imageUrls.length} ä¸ª`, 'info');
                imageUrls.forEach(url => log(`   - ${url}`, 'info'));
                
                // 3. æµ‹è¯•å›¾ç‰‡è½¬æ¢
                const response = await chrome.runtime.sendMessage({
                    type: 'FETCH_IMAGE_TO_DATAURL',
                    urls: imageUrls
                });
                
                if (response && response.results) {
                    let successCount = 0;
                    const container = document.createElement('div');
                    container.appendChild(fragment);
                    
                    // æ›¿æ¢å›¾ç‰‡URL
                    const containerImages = container.querySelectorAll('img');
                    containerImages.forEach(img => {
                        const result = response.results[img.src];
                        if (result && result.ok) {
                            img.src = result.dataUrl;
                            successCount++;
                        }
                    });
                    
                    log(`4ï¸âƒ£ å›¾ç‰‡è½¬æ¢ç»“æœ: ${successCount}/${imageUrls.length}`, successCount === imageUrls.length ? 'success' : 'warn');
                    
                    // 4. æµ‹è¯•å‰ªè´´æ¿å†™å…¥
                    const modifiedHtml = container.innerHTML;
                    const textContent = container.textContent;
                    
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            'text/html': new Blob([modifiedHtml], { type: 'text/html' }),
                            'text/plain': new Blob([textContent], { type: 'text/plain' })
                        })
                    ]);
                    
                    log('5ï¸âƒ£ å‰ªè´´æ¿å†™å…¥å®Œæˆ', 'success');
                    log('ğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆï¼', 'success');
                    
                    // æ›´æ–°å‰ªè´´æ¿çŠ¶æ€æ˜¾ç¤º
                    updateClipboardStatus(modifiedHtml, textContent);
                    
                } else {
                    log('âŒ å›¾ç‰‡è½¬æ¢å“åº”æ— æ•ˆ', 'error');
                }
                
            } catch (error) {
                log(`âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function updateClipboardStatus(html, text) {
            const dataUrlCount = (html.match(/src="data:image/g) || []).length;
            const httpUrlCount = (html.match(/src="http/g) || []).length;
            
            clipboardStatus.innerHTML = `
                <div class="status-item">
                    <strong>HTMLé•¿åº¦:</strong> ${html.length} å­—ç¬¦<br>
                    <strong>çº¯æ–‡æœ¬é•¿åº¦:</strong> ${text.length} å­—ç¬¦<br>
                    <strong>Data URLå›¾ç‰‡:</strong> ${dataUrlCount} ä¸ª<br>
                    <strong>HTTP URLå›¾ç‰‡:</strong> ${httpUrlCount} ä¸ª<br>
                    <strong>çŠ¶æ€:</strong> ${dataUrlCount > 0 ? 'âœ… åŒ…å«å†…è”å›¾ç‰‡' : (httpUrlCount > 0 ? 'âš ï¸ ä»æœ‰å¤–é“¾å›¾ç‰‡' : 'ğŸ” æ— å›¾ç‰‡')}
                </div>
            `;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        log('ğŸ”§ è°ƒè¯•å·¥å…·å·²åŠ è½½å®Œæˆ', 'success');
        log('ğŸ’¡ æç¤º: è¯·ç¡®ä¿Chromeæ’ä»¶å·²å®‰è£…å¹¶å¯ç”¨', 'info');
        
        // æ£€æŸ¥æ’ä»¶æ˜¯å¦å¯ç”¨
        if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
            log('âœ… Chromeæ‰©å±•APIå¯ç”¨', 'success');
        } else {
            log('âŒ Chromeæ‰©å±•APIä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æ’ä»¶å®‰è£…', 'error');
        }
    </script>
</body>
</html>
